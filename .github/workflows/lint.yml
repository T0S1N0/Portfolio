name: ğŸ” Lint Terraform

on:
  pull_request:
    paths:
      - "terraform/**"
      - ".github/workflows/lint.yml"

jobs:
  terraform-lint:
    name: ğŸ“ Terraform Lint
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: ğŸ“ Terraform Format Check
        working-directory: ./terraform
        run: |
          echo "::group::Checking Terraform formatting"
          terraform fmt -check -recursive
          echo "::endgroup::"
          echo "âœ… Format check passed"

      - name: âœ… Terraform Validate
        working-directory: ./terraform
        run: |
          echo "::group::Validating Terraform configuration"
          terraform init -backend=false
          terraform validate
          echo "::endgroup::"
          echo "âœ… Configuration is valid"

  tfsec:
    name: ğŸ”’ Security Scan (tfsec)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Run tfsec security scan
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: "terraform"
          additional_args: "--format sarif --out results.sarif"

      - name: ğŸ“¤ Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results.sarif
